<source>
  type forward
</source>
<source>
  type monitor_agent
  port 24220
</source>

# Syslog listener
<source>
  type syslog
  port 514
  bind 0.0.0.0
  tag forward.syslog
</source>

# Copy everything to S3
<match ec2.forward.**>
    type copy
    <store>
    type s3
        buffer_path /var/log/fluentd/s3.log
        check_apikey_on_start false
        s3_bucket {{ getv "/config/FluentLogsBucket" }}
        s3_region {{ getv "/config/AWSRegion" }}
        time_slice_format %Y/%m/%d/%H/%Y%m%d%H%M
        utc true
        use_ssl true
   </store>
{{ if exists "/config/SQS/Queue" }}
   <store>
     type sqs
     queue_name {{ getv "/config/SQS/Queue" }}
     create_queue false
{{ if exists "/config/SQS/AccessKey" }}aws_key_id {{ getv "/config/SQS/AccessKey" }}{{ end }}
{{ if exists "/config/SQS/SecretKey" }}aws_sec_key {{ getv "/config/SQS/SecretKey" }}{{ end }}
{{ if exists "/config/SQS/Region" }}
     sqs_endpoint sqs.{{ getv "/config/SQS/Region" }}.amazonaws.com
{{ else }}
     sqs_endpoint sqs.{{ getv "/config/AWSRegion" }}.amazonaws.com
{{ end }}
   </store>
{{ end }}

{{ if exists "/config/ElasticSearch/AWSEndpoint" }}
  # Ship to ElasticSearch
  <store>
    type aws-elasticsearch-service
    logstash_format true
    include_tag_key true
    flush_interval "15s"

    <endpoint>
      url {{ getv "/config/ElasticSearch/AWSEndpoint" }}
      {{ if exists "/config/ElasticSearch/Region" }}
      region {{ getv "/config/ElasticSearch/Region" }}
      {{ else }}
      region {{ getv "/config/AWSRegion" }}
      {{ end }}
    </endpoint>
  </store>
{{ end }}
</match>

{{ if exists "/config/AccessLoggingBucket" }}
# Pull in ELB logs
<source>
  type elb_log
  region            {{ getv "/config/AWSRegion" }}
  s3_bucketname     {{ getv "/config/AccessLoggingBucket" }}
  timestamp_file    /var/log/fluentd/elb.ts
  buf_file          /var/log/fluentd/elb.buf
  refresh_interval  15
  tag               ec2.forward.elb.access
</source>

{{ end }}
